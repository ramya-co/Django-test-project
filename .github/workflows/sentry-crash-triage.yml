name: Sentry Crash Triage

on:
  repository_dispatch:
    types: [sentry-crash]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  dispatch-to-copilot:
    runs-on: ubuntu-latest

    steps:
      # â”€â”€ Step 1: Create the triage issue â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # This issue is the task brief that the Copilot coding agent reads.
      # We immediately assign it to Copilot in Step 2.
      # The user never needs to touch the issue â€” only the draft PR it produces.
      - name: Create triage issue
        id: create-issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT }}
          script: |
            const cp      = context.payload.client_payload;
            const title   = cp.title   || 'Unknown error';
            const culprit = cp.culprit || 'unknown';
            const level   = cp.level   || 'error';
            const url     = cp.url     || '';

            const emoji      = { fatal: 'ðŸ”´', error: 'ðŸŸ ', warning: 'ðŸŸ¡' }[level] ?? 'âšª';
            const sentryLink = url ? `[View in Sentry](${url})` : '_not provided_';
            const slug = title.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '').slice(0, 55);

            // Ensure labels exist first
            for (const lbl of [
              { name: 'crash-fix', color: 'e11d48', description: 'Automated crash fix task' },
              { name: 'copilot',   color: '6366f1', description: 'Handled by Copilot coding agent' },
            ]) {
              try {
                await github.rest.issues.createLabel({ owner: context.repo.owner, repo: context.repo.repo, ...lbl });
              } catch (_) {}  // 422 = already exists, fine
            }

            const body = [
              `## ${emoji} Sentry Crash Detected`,
              '',
              '| Field | Value |',
              '|-------|-------|',
              `| **Exception** | \`${title}\` |`,
              `| **Culprit**   | \`${culprit}\` |`,
              `| **Level**     | \`${level}\` |`,
              `| **Sentry**    | ${sentryLink} |`,
              `| **Time**      | ${new Date().toISOString()} |`,
              '',
              '---',
              '',
              '## Task for @github-copilot',
              '',
              `@github-copilot A production crash has been detected. Your task is to **fix the bug and open a draft Pull Request** against \`main\`. Do not open any new issue as output.`,
              '',
              '**Complete these steps in order:**',
              '',
              '1. Read `.github/triage-instructions.md` â€” this is your full playbook (project map, code style, investigation checklist, mandatory PR template).',
              `2. Locate and read the culprit: \`${culprit}\`.`,
              '3. Understand the crash, check git history on that file, check for duplicate open PRs.',
              '4. Apply the minimal, targeted fix â€” no unrelated changes.',
              `5. Open a **draft PR** from branch \`fix/sentry-${slug}\` â†’ \`main\` using the PR template in \`.github/triage-instructions.md Â§5\`.`,
              `6. Include the Sentry URL (${url || 'see above'}) and \`Closes #<this issue number>\` in the PR description.`,
              '',
              '> âš ï¸ **Draft PR only. Do NOT mark ready for review. Do NOT auto-merge.**',
              '> The human engineer reviews, approves, and merges.',
            ].join('\n');

            const issue = await github.rest.issues.create({
              owner:  context.repo.owner,
              repo:   context.repo.repo,
              title:  `[Crash] ${title}`,
              body,
              labels: ['crash-fix', 'copilot'],
            });

            core.setOutput('issue_number', String(issue.data.number));
            core.setOutput('issue_url',    issue.data.html_url);
            core.setOutput('slug',         slug);
            core.notice(`âœ… Issue #${issue.data.number} created: ${issue.data.html_url}`);

      # â”€â”€ Step 2: Assign to Copilot coding agent automatically â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # This is what triggers Copilot to start working â€” no human action needed.
      - name: Assign issue to Copilot
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT }}
          script: |
            const issueNumber = parseInt('${{ steps.create-issue.outputs.issue_number }}');
            try {
              await github.rest.issues.addAssignees({
                owner:        context.repo.owner,
                repo:         context.repo.repo,
                issue_number: issueNumber,
                assignees:    ['copilot'],
              });
              core.notice(`âœ… Issue #${issueNumber} assigned to Copilot coding agent`);
            } catch (err) {
              // If direct assignment fails (e.g. Copilot app not installed),
              // fall back to a mention comment which also triggers the agent.
              core.warning(`Direct assignment failed (${err.message}) â€” posting trigger comment`);
              await github.rest.issues.createComment({
                owner:        context.repo.owner,
                repo:         context.repo.repo,
                issue_number: issueNumber,
                body: [
                  `@github-copilot Please fix this crash now.`,
                  '',
                  'Follow `.github/triage-instructions.md` exactly.',
                  'Open a **draft PR** â€” do not auto-merge.',
                ].join('\n'),
              });
            }

      # â”€â”€ Step 3: Write workflow summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Write job summary
        run: |
          {
            echo "## ðŸ”´ Sentry Crash â†’ Copilot Dispatched"
            echo ""
            echo "| | |"
            echo "|---|---|"
            echo "| Title   | ${{ github.event.client_payload.title }} |"
            echo "| Culprit | \`${{ github.event.client_payload.culprit }}\` |"
            echo "| Level   | ${{ github.event.client_payload.level }} |"
            echo "| Sentry  | ${{ github.event.client_payload.url }} |"
            echo "| Issue   | ${{ steps.create-issue.outputs.issue_url }} |"
            echo ""
            echo "Copilot has been assigned. A **draft PR** will appear shortly."
            echo "**Your only job:** review the PR, approve it, and merge."
          } >> "$GITHUB_STEP_SUMMARY"

