name: Sentry Crash Triage

# â”€â”€ Trigger â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Fires when the Django /webhooks/sentry/ view POSTs to GitHub's
# repository_dispatch API with event_type: "sentry-crash".
on:
  repository_dispatch:
    types: [sentry-crash]

# â”€â”€ Permissions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
permissions:
  contents: write        # Copilot agent: create fix branch
  issues: write          # create the Copilot task-issue
  pull-requests: write   # Copilot agent: open the draft PR

# â”€â”€ Job â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
jobs:
  dispatch-to-copilot:
    runs-on: ubuntu-latest

    steps:
      # â”€â”€ Create a Copilot task-issue â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # The issue is the task brief for the Copilot coding agent.
      # The agent reads .github/triage-instructions.md, applies the fix,
      # and opens a DRAFT PR. Human reviews, approves, and merges.
      # There is NO auto-merge and NO fallback analysis-issue output.
      - name: Create Copilot fix-task issue
        id: create-issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const cp      = context.payload.client_payload;
            const title   = cp.title   || 'Unknown error';
            const culprit = cp.culprit || 'unknown';
            const level   = cp.level   || 'error';
            const url     = cp.url     || '';

            const emoji      = { fatal: 'ðŸ”´', error: 'ðŸŸ ', warning: 'ðŸŸ¡' }[level] ?? 'âšª';
            const sentryLink = url ? `[View in Sentry](${url})` : '_not provided_';
            const triggeredAt = new Date().toISOString();

            // Slugify crash title for a readable branch name suggestion
            const slug = title
              .toLowerCase()
              .replace(/[^a-z0-9]+/g, '-')
              .replace(/^-|-$/g, '')
              .slice(0, 55);

            const body = [
              `## ${emoji} Sentry Crash â€” Fix Request`,
              '',
              '| Field | Value |',
              '|-------|-------|',
              `| **Title**       | ${title} |`,
              `| **Culprit**     | \`${culprit}\` |`,
              `| **Level**       | \`${level}\` |`,
              `| **Sentry URL**  | ${sentryLink} |`,
              `| **Detected at** | ${triggeredAt} |`,
              '',
              '---',
              '',
              '## Task for @github-copilot',
              '',
              `@github-copilot A production crash has been detected. Your task is to **fix it and open a draft Pull Request** targeting \`main\`. Do not open any issue as output.`,
              '',
              '**Please complete the following steps in order:**',
              '',
              '1. Read `.github/triage-instructions.md` â€” it contains the full investigation playbook, this project\'s code map, style guide, and the mandatory PR description template.',
              `2. Locate the culprit code: \`${culprit}\`.`,
              '3. Follow every investigation step in the playbook (understand crash â†’ check git history â†’ check existing PRs â†’ apply minimal fix).',
              `4. Open a **draft PR** from branch \`fix/sentry-${slug}\` targeting \`main\`.`,
              `5. Use the PR description template from \`.github/triage-instructions.md\` â€” include the Sentry URL and \`Closes #<this issue number>\`.`,
              '',
              '> âš ï¸ **Do not auto-merge.** The PR must remain a draft until the human reviewer approves it.',
            ].join('\n');

            // Ensure labels exist (ignore 422 if already present)
            for (const lbl of [
              { name: 'crash-fix', color: 'e11d48', description: 'Automated crash fix task for Copilot agent' },
              { name: 'copilot',   color: '6366f1', description: 'Assigned to GitHub Copilot coding agent'     },
            ]) {
              try {
                await github.rest.issues.createLabel({ owner: context.repo.owner, repo: context.repo.repo, ...lbl });
              } catch (_) {}
            }

            const issue = await github.rest.issues.create({
              owner:  context.repo.owner,
              repo:   context.repo.repo,
              title:  `[Fix Request] ${title}`,
              body,
              labels: ['crash-fix', 'copilot'],
            });

            core.notice(`âœ… Copilot task issue #${issue.data.number}: ${issue.data.html_url}`);
            core.setOutput('issue_number', String(issue.data.number));
            core.setOutput('issue_url',    issue.data.html_url);

      # â”€â”€ Write workflow summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Write job summary
        run: |
          {
            echo "## ðŸ”´ Sentry Crash â€” Dispatched to Copilot"
            echo ""
            echo "| Field | Value |"
            echo "|-------|-------|"
            echo "| Title   | ${{ github.event.client_payload.title }} |"
            echo "| Culprit | \`${{ github.event.client_payload.culprit }}\` |"
            echo "| Level   | ${{ github.event.client_payload.level }} |"
            echo "| Sentry  | ${{ github.event.client_payload.url }} |"
            echo "| Task Issue | ${{ steps.create-issue.outputs.issue_url }} |"
            echo ""
            echo "Copilot is working on a fix. A draft PR will appear shortly."
            echo "Review â†’ Approve â†’ Merge when ready."
          } >> "$GITHUB_STEP_SUMMARY"
